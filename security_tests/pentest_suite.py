import sys
import os
import subprocess
import json
import ast

# Add project root to path to import SecurityGate
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), '..', 'mcp-server')))
from security_gate import SecurityGate

class RedTeamSuite:
    def __init__(self):
        self.results = {"passed": 0, "failed": 0, "details": []}

    def log_test(self, category, name, code, expected_blocked=True):
        print(f"[*] Testing [{category}] {name}...", end=" ", flush=True)
        errors = []
        try:
            if category == "Python": errors = SecurityGate.check_python(code)
            elif category == "Shell": errors = SecurityGate.check_shell(code)
        except Exception as e:
            errors = [f"Auditor Crashed: {str(e)}"]
        
        is_blocked = len(errors) > 0
        success = is_blocked == expected_blocked
        if success:
            print("✅ SUCCESS")
            self.results["passed"] += 1
        else:
            print("❌ FAILED (Bypass Detected!)")
            self.results["failed"] += 1
        
        self.results["details"].append({
            "category": category, "name": name, "success": success,
            "is_blocked": is_blocked, "errors": errors
        })

    def run_python_tests(self):
        print("\n--- Running Python Attack Vectors ---")
        self.log_test("Python", "Nested Try-Except Import", "try:\n  try: __import__('o' + 's').system('ls')\n  except: pass\nexcept: pass")
        self.log_test("Python", "Generator Comprehension RCE", "[c.system('ls') for c in [__import__('os')]]")
        self.log_test("Python", "Lambda Decorator Hijack", "@lambda f: __import__('os').system('ls')\ndef s(): pass")
        self.log_test("Python", "Recursive Subclass Lookup", "def f(c): return [s for s in c.__subclasses__()]")
        self.log_test("Python", "Dictionary Key Obfuscation", "m = __builtins__; m.__dict__['ex'+'ec']('import os')")
        self.log_test("Python", "getattr Obfuscation", "getattr(__import__('os'), 'system')('ls')")
        self.log_test("Python", "Unicode Homoglyph Bypass", "еxec('ls')") # Uses Cyrillic 'e'

    def run_blender_specific_tests(self):
        print("\n--- Running Blender Specific Attack Vectors ---")
        self.log_test("Python", "Direct bpy Import", "import bpy; bpy.ops.wm.quit_blender()")
        self.log_test("Python", "Dangerous Operator Escape", "bpy.ops.wm.execute_python(filepath='evil.py')")
        self.log_test("Python", "Hidden bpy access via getattr", "getattr(__import__('bpy').ops.wm, 'quit_blender')()")
        self.log_test("Python", "OSL Shader Node Escape Attempt", "mat = bpy.data.materials.new('evil'); mat.use_nodes = True; mat.node_tree.nodes.new('ShaderNodeScript')")
        self.log_test("Python", "Addon Install Hijack", "bpy.ops.wm.addon_install(filepath='/tmp/evil.zip')")
        self.log_test("Python", "File Overwrite via bpy.ops.wm.save", "bpy.ops.wm.save_as_mainfile(filepath='system_config.blend')")

    def run_shell_tests(self):
        print("\n--- Running Shell Attack Vectors ---")
        self.log_test("Shell", "Bridge Bypass", "python3 -c \"import os; os.system('ls')\"")
        self.log_test("Shell", "Unauthenticated curl MITM", "curl http://localhost:22000/status")
        self.log_test("Shell", "LD_PRELOAD Hijack", "LD_PRELOAD=/tmp/evil.so ls")
        self.log_test("Shell", "PYTHONPATH Hijack", "PYTHONPATH=/tmp/evil python3 -c 'import os'")

    def run_interference_tests(self):
        print("\n--- Running Interference Attack Vectors ---")
        self.log_test("Python", "Socket Hijack", "import socket; s=socket.socket(); s.bind(('127.0.0.1',22000))")
        self.log_test("Python", "Infinite Loop (DoS)", "while True: pass")
        self.log_test("Python", "Memory Exhaustion (DoS)", "x = 'A' * 10**8")

    def run_all(self):
        print("=== BlenderVibeBridge Security Pentest Suite ===")
        self.run_python_tests()
        self.run_blender_specific_tests()
        self.run_shell_tests()
        self.run_interference_tests()
        
        print("\n=== Final Results ===")
        print(f"Passed: {self.results['passed']}")
        print(f"Failed: {self.results['failed']}")
        
        if self.results["failed"] > 0:
            print("\n[!] CRITICAL: Security Bypasses Detected!")
            sys.exit(1)
        else:
            print("\n[+] Integrity Verified: Iron Box is Secure.")
            sys.exit(0)

if __name__ == "__main__":
    suite = RedTeamSuite()
    suite.run_all()
