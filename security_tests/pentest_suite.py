# BlenderVibeBridge: Dual-License & Maintenance Agreement (v1.2)
# Copyright (C) 2026 B-A-M-N (The "Author")
#
# This software is distributed under a Dual-Licensing Model:
# 1. THE OPEN-SOURCE PATH: GNU AGPLv3 (see LICENSE for details)
# 2. THE COMMERCIAL PATH: "WORK-OR-PAY" MODEL
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU Affero General Public License for more details.

import sys
import os
import subprocess
import json
import ast

# Add project root to path to import SecurityGate
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), '..', 'mcp-server')))
from security_gate import SecurityGate

class RedTeamSuite:
    def __init__(self):
        self.results = {"passed": 0, "failed": 0, "details": []}

    def run_asset_tests(self):
        print("\n--- Running Asset Attack Vectors ---")
        # Create a dummy malicious asset
        malicious_path = "/tmp/evil_asset.blend"
        with open(malicious_path, "wb") as f:
            f.write(b"BLENDER-v300" + b"\x00" * 100 + b"import os; os.system('ls')")
        
        self.log_test("Asset", "Embedded Script in Binary", malicious_path)
        
        safe_path = "/tmp/safe_asset.blend"
        with open(safe_path, "wb") as f:
            f.write(b"BLENDER-v300" + b"\x00" * 100 + b"Just some mesh data")
        
        self.log_test("Asset", "Clean Binary Asset", safe_path, expected_blocked=False)
        
        # Cleanup
        os.remove(malicious_path)
        os.remove(safe_path)

    def log_test(self, category, name, code, expected_blocked=True):
        print(f"[*] Testing [{category}] {name}...", end=" ", flush=True)
        errors = []
        try:
            if category == "Python": errors = SecurityGate.check_python(code)
            elif category == "Asset": errors = SecurityGate.check_asset(code)
        except Exception as e:
            errors = [f"Auditor Crashed: {str(e)}"]
        
        is_blocked = len(errors) > 0
...
    def run_interference_tests(self):
        print("\n--- Running Interference Attack Vectors ---")
        self.log_test("Python", "Socket Hijack", "import socket; s=socket.socket(); s.bind(('127.0.0.1',22000))")
        self.log_test("Python", "Infinite Loop (DoS)", "while True: pass")
        self.log_test("Python", "Memory Exhaustion (DoS)", "x = 'A' * 10**8")

    def run_all(self):
        print("=== BlenderVibeBridge Security Pentest Suite ===")
        self.run_python_tests()
        self.run_blender_specific_tests()
        self.run_interference_tests()
        self.run_asset_tests()
        
        print("\n=== Final Results ===")
        print(f"Passed: {self.results['passed']}")
        print(f"Failed: {self.results['failed']}")
        
        if self.results["failed"] > 0:
            print("\n[!] CRITICAL: Security Bypasses Detected!")
            sys.exit(1)
        else:
            print("\n[+] Integrity Verified: Iron Box is Secure.")
            sys.exit(0)

if __name__ == "__main__":
    suite = RedTeamSuite()
    suite.run_all()
